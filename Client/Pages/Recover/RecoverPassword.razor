@page "/recover/password"
@inject IUsersRepository _usersRepository
@inject IToastService _toastService

<TopSemicircleComponent />
<RecoveryContainerComponent Title="Password recovery" Description="Forgot your account’s password and can't login? Enter your email address and we'll send you a mail, that can help you.">
    <GenericFormComponent Model="@_recoverDto" @ref="_form" OnValidSubmit="@RecoverPasswordAsync" IsAutoCompleteOn="false" RequireCaptcha="true">
        <FormInputComponent Type="text" @bind-Value="@_recoverDto.Email" Placeholder="Email address" />
        <FormSubmitComponent IsPending="@_isPending" SubmitText="Recover password" PendingSubmitText="Processing..." />
    </GenericFormComponent>
</RecoveryContainerComponent>

@code {

    /// <summary>
    ///     Model formularza
    /// </summary>
    private RecoverDTO _recoverDto = new();

    /// <summary>
    ///     Zmienna mowiąca o tym, czy formularz jest w trakcie przetwarzania
    /// </summary>
    private bool _isPending;

    /// <summary>
    ///     Referencja do komponentu formularza
    /// </summary>
    private GenericFormComponent<RecoverDTO> _form;

    /// <summary>
    ///     Metoda wysyłająca oraz obsługująca żądanie odzyskania hasła - wywoływana przy potwierdzeniu prawidłowo
    ///     wypełnionego formularza
    /// </summary>
    /// <param></param>
    /// <returns></returns>
    private async Task RecoverPasswordAsync()
    {
        _isPending = true;
        _recoverDto.CaptchaResponseToken = await _form.CaptchaComponent.GetCaptchaResponseAsync();

        var isRecovered = await _usersRepository.RecoverPasswordAsync(_recoverDto);
        if (!isRecovered)
        {
            _toastService.ShowError("Invalid reCaptcha.");
            await _form.CaptchaComponent.ResetCaptchaAsync();
        }
        else
        {
            _toastService.ShowSuccess("Password recovery email has been send.");
            _recoverDto = new RecoverDTO();
        }

        _isPending = false;
    }

}